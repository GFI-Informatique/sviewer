<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
    <!--
GeoBretagne simple viewer

$Rev: 74 $
$Date: 2012-11-08 20:32:54 +0000 (jeu. 08 nov. 2012) $
$Author: fabrice.phung $
    -->
    <head>
        <title>visualiseur simple GeoBretagne</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <!-- libraries -->
        <script type="text/javascript" src="lib/OpenLayers/lib/OpenLayers.js"></script>
        <script type="text/javascript" src="lib/proj4js/proj4js-compressed.js"></script>
        <script type="text/javascript" src="lib/LoadingPanel.js"></script>

        <!-- local -->
        <link rel="stylesheet" href="style/ol.css" type="text/css" />

        <script type="text/javascript">
/***********************************************************************************************
 * configuration
 */

// libraries configuration
OpenLayers.DOTS_PER_INCH = 90.71428571428572;
OpenLayers.Util.onImageLoadErrorColor = 'transparent';
OpenLayers.ProxyHost = '/proxy/?url=';
Proj4js.defs["EPSG:900913"] = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs";
Proj4js.defs["EPSG:2154"] = "+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
Proj4js.defs["EPSG:4326"] = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";


// application hardcoded configuration
var hardConfig = {
    // viewer title, may be overriden with &title=text
    title: "visualiseur simple GeoBretagne",

    // default wms onlineResource for &layers=layernames
    wms: "http://geobretagne.fr/geoserver/ows",

    // initial extent and zoom, may be overriden with &x=lon&y=lat&z=zoom
    initialExtent: new OpenLayers.Bounds(145518, 6726671, 372058, 6868691),
    zinit: 8,

    // must match the TMS grid&scale if any
    maxExtent: new OpenLayers.Bounds(-357823.2365, 6037008.6939, 2146865.3059, 8541697.2363),
    maxResolution: 156543.0339,

    // map center restricted in this extent
    restrictedExtent: new OpenLayers.Bounds(45518, 6626671, 472058, 6968691),

    // map projection
    projMap: new OpenLayers.Projection('EPSG:2154'),

    // permalink and kml projection
    projDisplay: new OpenLayers.Projection('EPSG:4326'),

    // maximum features retrieved on getFeatureInfo
    maxFeatures: 3,

    // string matching empty gfi response, set your templates !
    nodata: '<!--nodatadetect-->\n<!--nodatadetect-->',

    // array of background map layers. Only one shall be visible on startup.
    // The user can switch layers using a button.
    layersBackground: [
        new OpenLayers.Layer.WMS(
            "Plan OpenStreetMap",
            "http://osm.geobretagne.fr/gwc01/service/wms",
            { layers: 'imposm:default', format: 'image/png', transparent: false },
            {
                attribution: "OpenStreetMap CC-by-SA",
                isBaseLayer: false,
                tileSize: new OpenLayers.Size(256,256),
                transitionEffect: 'resize',
                visibility: true
            }
        ),
        new OpenLayers.Layer.WMS(
            "Photographie aérienne",
            "http://tile.geobretagne.fr/gwc02/service/wms",
            { layers: 'satellite', format: 'image/jpeg', transparent: false },
            {
                attribution: "partenaires GéoBretagne, IGN RGE BD ORTHO, PlanetObserver",
                isBaseLayer: false,
                tileSize: new OpenLayers.Size(256,256),
                transitionEffect: 'resize',
                visibility: false
            }
        )
    ],

    // array of overlay layers. They are always visible.
    layersOverlay: [
        //~ new OpenLayers.Layer.WMS(
            //~ "départements",
            //~ "http://geobretagne.fr/geoserver/geob_loc/wms",
            //~ { layers: 'geob_loc:DEPARTEMENT', format: 'image/png', transparent: true },
            //~ {
                //~ attribution: "IGN BDCARTO",
                //~ isBaseLayer: false,
                //~ tileSize: new OpenLayers.Size(512,512),
                //~ transitionEffect: 'resize'
            //~ }
        //~ )
    ]
}


/**
 * end configuration
 ***********************************************************************************************
 */


var map;

function init(){

    // defaultConfig may be overriden with querystring
    var defaultConfig = {
        title: hardConfig.title
    }

    var config = {};

    /**
     * Fetching parameters from url hash or querystring
     */
    OpenLayers.Util.applyDefaults(config, OpenLayers.Util.getParameters("?"+window.location.hash.substr(1)));
    OpenLayers.Util.applyDefaults(config, OpenLayers.Util.getParameters(window.location.href));
    OpenLayers.Util.applyDefaults(config, defaultConfig);

    // document title handling
    document.title = config.title;
    var domTitle = OpenLayers.Util.getElement("title");
    domTitle.appendChild(document.createTextNode(config.title));


    /**
     * MAP
     */
    var mapOptions = {
        projection: hardConfig.projMap,
        displayProjection: hardConfig.projDisplay,
        maxExtent: hardConfig.maxExtent,
        restrictedExtent: hardConfig.restrictedExtent,
        maxResolution: hardConfig.maxResolution,
        units: "m",
        controls: [
            new OpenLayers.Control.KeyboardDefaults(),
            new OpenLayers.Control.Navigation({
                mouseWheelOptions: {
                    cumulative: false,
                    interval: 20
                },
                dragPanOptions: {
                    enableKinetic: {
                        deceleration: 0.02
                }
            }}),
            new OpenLayers.Control.ZoomBox(),
            new OpenLayers.Control.Attribution({div:OpenLayers.Util.getElement("attribution")}),
            new OpenLayers.Control.LoadingPanel()
        ],
        layers: [new OpenLayers.Layer("fake", {isBaseLayer: true, displayInLayerSwitcher: false})]
    };
    map = new OpenLayers.Map('map', mapOptions );

    // "previous extent" control
    var navHistory = new OpenLayers.Control.NavigationHistory({
        previousOptions: { title: "retour" }
    });
    map.addControl(navHistory);

    // toolbar on the map
    var panel = new OpenLayers.Control.Panel({ autoActivate: true });
    map.addControl(panel);
    panel.addControls([
        new OpenLayers.Control.ZoomToMaxExtent({title: "vue initiale"}),
        navHistory.previous,
        new OpenLayers.Control.ZoomIn({title: "zoom avant"}),
        new OpenLayers.Control.ZoomOut({title: "zoom arri&egrave;re"})
    ]);



    /**
     * background layers
     */

    map.addLayers(hardConfig.layersBackground);
    // backgroundLayers switch button
    panel.addControls(
        [new OpenLayers.Control.Button({
            displayClass: "btLayerSwitch",
            trigger: function() {
                var ll=hardConfig.layersBackground;
                var n=ll.length;
                var lv=0;
                for (i=0;i<n;i+=1) {
                    if (ll[i].getVisibility()) { lv=i }
                    ll[i].setVisibility(false);
                }
                ll[(lv+1)%n].setVisibility(true);
            }
        })]
    );

    /**
     * overlay layers
     */
    if (hardConfig.hasOwnProperty("layersOverlay")) {
        map.addLayers(hardConfig.layersOverlay)
    }


    /**
     * Optional WMS layer providing onclick getFeatureInfo
     * Activated with &layers=layernames
     * This WMS layer must be queryable with info_format text/html
     */
    if (config.layers) {
        var popup, layer_wms, getFeatureInfo;

        // fake popup function
        var popup = { destroy: function() {} };

        var layer_wms = new OpenLayers.Layer.WMS(
            config.title,
            hardConfig.wms, {
                layers: config.layers,
                format: "image/png",
                transparent: true
            },{
                isBaseLayer: false,
                singleTile: true,
                ratio: 1.2,
                transitionEffect: 'resize'
            }
        );
        map.addLayer(layer_wms);

        var getFeatureInfo = new OpenLayers.Control.WMSGetFeatureInfo({
            url: hardConfig.wms,
            title: 'Interroger la carte par clic',
            queryVisible: true,
            infoFormat: 'text/html',
            hover: false,
            handlerOptions: {
                "hover": { delay: 500 }
            },
            maxFeatures: hardConfig.maxFeatures,
            layers: [layer_wms],
            eventListeners: {
                "getfeatureinfo": function(e) {
                    if (e.text.search(hardConfig.nodata)<0) {
                        popup.destroy();
                        popup = new OpenLayers.Popup.FramedCloud(
                            "wmsPopup",
                            map.getLonLatFromPixel(e.xy),
                            new OpenLayers.Size(200,200),
                            e.text,
                            null,
                            true);
                        map.addPopup(popup);
                    }
                }
            }
        });
        map.addControl(getFeatureInfo);
        getFeatureInfo.activate();
    }


    /**
     * Optional KML Layer activated with &kml=kmlurl
     */
    if (config.kml) {

        function onPopupClose(e) {
            selectControl.unselectAll();
        }
        function onFeatureSelect(e) {
            var f = e.feature;
            var content = ["<h2>",config.title,"</h2>","<p>",
                "<span class='pname'>",f.attributes.name,"</span><br />",
                "<span class='pdesc'>",f.attributes.description,"</span>","</p>"].join(' ');
            // no dynamic content allowed
            if (content.search("<script") != -1) { content = content.replace(/</g, "&lt;"); }
            var popup = new OpenLayers.Popup.FramedCloud(
                "kmlPopup",
                f.geometry.getBounds().getCenterLonLat(),
                new OpenLayers.Size(100,100),
                content,
                null,
                true,
                onPopupClose
            );
            popup.autoSize = true;
            popup.maxSize = new OpenLayers.Size(300,200);
            f.popup = popup;
            map.addPopup(popup);
        }
        function onFeatureUnselect(e) {
            var f = e.feature;
            if(f.popup) {
                map.removePopup(f.popup);
                f.popup.destroy();
                delete f.popup;
            }
        }

        var layer_kml = new OpenLayers.Layer.Vector(
            config.title,
            {
                strategies: [new OpenLayers.Strategy.Fixed()],
                projection: hardConfig.projDisplay,
                protocol: new OpenLayers.Protocol.HTTP({
                    url: config.kml,
                    format: new OpenLayers.Format.KML({
                    extractStyles: true,
                    extractAttributes: true
                })
            }),
            eventListeners: {
                "featureselected":onFeatureSelect,
                "featureunselected":onFeatureUnselect
            }
        });
        map.addLayer(layer_kml);
        var selectControl = new OpenLayers.Control.SelectFeature(layer_kml, {toggle: true, clickout:false});
        selectControl.handlers['feature'].stopDown = false;
        selectControl.handlers['feature'].stopUp = false;
        map.addControl(selectControl);
        selectControl.activate();
        layer_kml.events.fallThrough = true;
    }


    /**
     * permalinks and helplink
     */
    // qrcode element
    //~ var qrcode = document.getElementById("qrcode");

    // reading map initial extent from permalink
    if (!map.getCenter()) {
        var center = hardConfig.initialExtent.getCenterLonLat();
        var zoom = hardConfig.zinit;
        OpenLayers.Util.applyDefaults(config, {x:center.lon, y:center.lat, z:zoom});
        map.setCenter(new OpenLayers.LonLat(config.x, config.y), config.z);
    }

    // keeping permalink synchronized with the map extent
    var permalink = OpenLayers.Util.getElement("permalink");
    function setPermalink() {
        var c = map.getCenter();
        var linkParams = {};
        linkParams.x = encodeURIComponent(Math.round(c.lon));
        linkParams.y = encodeURIComponent(Math.round(c.lat));
        linkParams.z = encodeURIComponent(map.getZoom());
        if (config.kml) { linkParams.kml = config.kml; }
        if (config.layers) { linkParams.layers = config.layers; }
        if (config.title) { linkParams.title = config.title; }
        permalink.href = OpenLayers.Util.urlAppend(window.location.href.split('?')[0],
            OpenLayers.Util.getParameterString(linkParams)
        );
        //~ qrcode.src="http://chart.apis.google.com/chart?cht=qr&chs=140x140&chl=" + encodeURIComponent(window.location);
    }
    map.events.register("moveend", map, setPermalink);
    setPermalink();

    // help frame display toggle
    var toggleHelp = function() {
        var d = OpenLayers.Util.getElement("helpFrame")
        d.style.display = d.style.display=="block"?"none":"block";
        return false;
    }
    OpenLayers.Util.getElement("helplink").onclick = toggleHelp;
    OpenLayers.Util.getElement("helpclose").onclick = toggleHelp;
}
    </script>
    <style type="text/css">
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: verdana, geneva, arial, sans-serif;
}
#banner {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    font-size: small;
    color: #ffffff;
    background-color: #333333;
    box-shadow: 0 0 10px #ffffff;
    z-index: 3000;
}
#banner h1 {
    text-align: left;
    font-size: small;
    margin: 0;
    padding: 0.2em 0.5em 0.2em 0.5em;
    text-shadow: 1px 1px 1.5px #000000;
}
#banner a {
    float: right;
    margin-right: 0.5em;
    padding: 1px;
    font-weight: bold;
    color: #ffffff;
    text-decoration: none;
	-webkit-border-radius: 4px;
	-moz-border-radius: 4px;
	border-radius: 4px;
	-khtml-border-radius: 4px;
}
#banner a:hover {
    color: #333333;
    background-color: #ffffff;
}
#attributionFrame {
    position: absolute;
    bottom: 0;
    right: 0;
    padding: 0;
    font-size: x-small;
    color: #000000;
    z-index: 1000;
}
#helpFrame {
    display: none;
    position: absolute;
    top: 1em;
    right: 0;
    margin-left: 80px;
    padding: 1em;
    color: #333333;
    background-color: #ffffff;
    box-shadow: 0 0 10px #333333;
    z-index: 1000;
}
#helpFrame a {
    padding: 0.2em 1em 0.2em 1em;
    font-weight: bold;
    color: #ffffff;
    background-color: #333333;
	-webkit-border-radius: 4px;
	-moz-border-radius: 4px;
	border-radius: 4px;
	-khtml-border-radius: 4px;
}
#helpFrame table {
    border-collapse:collapse;
}
#helpFrame table td {
    padding: 0.3em;
    border-bottom: 1px dotted #999999;
}
#helpFrame p {
    text-align: right;
}
#helpFrame .ico {
    width: 20px;
    height: 20px;
	border: 2px solid #333333;
	-webkit-border-radius: 4px;
	-moz-border-radius: 4px;
	border-radius: 4px;
	-khtml-border-radius: 4px;
}
#map {
    position: relative;
    width: 100%;
    height: 100%;
}


        </style>
    </head>
    <body>
        <noscript>cette page requiert l'activation de javascript</noscript>
        <div id="banner">
            <a id="helplink" href="." title="aide">aide</a>
            <a id="permalink" class="permalink" href="." title="lien permanent sur la vue actuelle">
            lien permanent
            </a>
            <h1 id="title"></h1>
        </div>
        <div id="attributionFrame">
            cr&eacute;dits : partenaires G&eacute;oBretagne,
            <span id="attribution"></span>
        </div>
        <div id="helpFrame">
            <table>
                <tbody>
                    <tr>
                        <td><img class="ico" src="img/home.png" title="bouton &eacute;tendue globale" /></td>
                        <td>
                            positionne la carte sur l'&eacute;tendue globale.
                        </td>
                    </tr>
                    <tr>
                        <td><img class="ico" src="img/back.png" title="bouton annuler dernier d&eacute;placement" /></td>
                        <td>
                            annule le dernier d&eacute;placement de carte.
                        </td>
                    </tr>
                    <tr>
                        <td><img class="ico" src="img/plus.png" title="bouton zoom avant" /></td>
                        <td>
                            Effectue un zoom avant.
                            Alternative: touche [+] du clavier.
                        </td>
                    </tr>
                    <tr>
                        <td><img class="ico" src="img/minus.png" title="bouton zoom arri&egrave;re" /></td>
                        <td>
                            effectue un zoom arri&egrave;re.
                            Alternative: touche [-] du clavier.
                        </td>
                    </tr>
                    <tr>
                        <td><img class="ico" src="img/layer.png" title="bouton fond de plan" /></td>
                        <td>
                            change le fond de plan.
                        </td>
                    </tr>
                    <tr>
                        <td>clic</td>
                        <td>Interroge sur la carte.</td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>
                        Pour se d&eacute;placer sur la carte,
                        maintenir le bouton souris et glisser sur la carte, ou touches fl&eacute;ch&eacute;es du clavier.
                        </td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>
                        Pour recadrer la carte,
                        maintenir la touche MAJ du clavier et tracer un rectangle avec la souris, bouton maintenu.
                        </td>
                    </tr>
                    <tr>
                        <td>lien permanent</td>
                        <td>
                        Pour partager la carte, cliquer sur "lien permanent" dans la barre de titre.
                        Utilisez ce lien pour envoyer la carte &agrave; vos contacts.</td>
                    </tr>
                    <tr>
                        <td>&eacute;crans tactiles</td>
                        <td>Glisser sur l'&eacute;cran pour se d&eacute;placer sur la carte.
                        Pincer l'&eacute;cran pour effectuer un zoom avant/arri&egrave;re.
                        </td>
                    </tr>
                </tbody>
            </table>
            <p>
                <a id="helpclose" href="" title="fermer l'aide">fermer</a>
            </p>
        </div>
        <div id="map"></div>
        <script>init();</script>
    </body>
</html>
